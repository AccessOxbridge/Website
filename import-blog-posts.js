#!/usr/bin/env node

import { createClient } from '@supabase/supabase-js'
import { readFileSync } from 'fs'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

// Load environment variables from portal/.env.local
function loadEnvVars() {
  try {
    const envPath = join(__dirname, '../portal/.env.local')
    const envContent = readFileSync(envPath, 'utf8')
    const envVars = {}

    envContent.split('\n').forEach(line => {
      const [key, ...valueParts] = line.split('=')
      if (key && valueParts.length > 0) {
        envVars[key.trim()] = valueParts.join('=').trim().replace(/^["']|["']$/g, '')
      }
    })

    return envVars
  } catch (error) {
    console.error('Error loading environment variables:', error.message)
    return {}
  }
}

const envVars = loadEnvVars()
const supabaseUrl = envVars.NEXT_PUBLIC_SUPABASE_URL
const serviceRoleKey = envVars.SUPABASE_SERVICE_ROLE_KEY
const anonKey = envVars.NEXT_PUBLIC_SUPABASE_ANON_KEY

if (!supabaseUrl) {
  console.error('Missing Supabase URL. Please check portal/.env.local file')
  process.exit(1)
}

// Use service role key if available (bypasses RLS), otherwise use anon key
const supabaseKey = serviceRoleKey || anonKey

if (!supabaseKey) {
  console.error('Missing Supabase key. Please check portal/.env.local file')
  process.exit(1)
}

console.log(`Using ${serviceRoleKey ? 'service role' : 'anon'} key for import`)
const supabase = createClient(supabaseUrl, supabaseKey)

// Import the velite-generated blog data
async function importBlogPosts() {
  try {
    console.log('Starting blog post import...')

    // Import the blog data generated by velite
    const { blog } = await import('./.velite/index.js')

    console.log(`Found ${blog.length} blog posts to import`)

    for (const post of blog) {
      console.log(`Importing: ${post.title}`)

      // Calculate reading time (words / 200)
      const content = post.body.toString()
      const words = content.split(/\s+/).length
      const readingTime = Math.ceil(words / 200)

      // Transform the data to match our database schema
      const articleData = {
        slug: post.slug,
        title: post.title,
        description: post.description,
        author: post.author,
        published_at: new Date(post.publishedAt).toISOString(),
        updated_at: post.updatedAt ? new Date(post.updatedAt).toISOString() : null,
        category: post.category,
        tags: post.tags || [],
        image: post.image,
        featured: post.featured || false,
        body: content,
        reading_time: readingTime,
      }

      // Insert into Supabase
      const { data, error } = await supabase
        .from('articles')
        .upsert(articleData, {
          onConflict: 'slug',
          ignoreDuplicates: false
        })
        .select()

      if (error) {
        console.error(`Error importing ${post.title}:`, error)
      } else {
        console.log(`âœ“ Successfully imported: ${post.title}`)
      }
    }

    console.log('Blog post import completed!')
  } catch (error) {
    console.error('Import failed:', error)
    process.exit(1)
  }
}

// Run the import
importBlogPosts()
